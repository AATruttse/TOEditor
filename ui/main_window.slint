import { Button, VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";

export component LibraryDialog inherits Window {
    width: 500px;
    height: 400px;
    title: "Library Properties";
    
    in-out property <string> library-name: "";
    in-out property <string> library-country: "";
    in-out property <string> library-era: "";
    in-out property <string> library-author: "";
    in-out property <string> library-tags: "";
    
    callback accepted();
    callback cancelled();
    
    VerticalBox {
        padding: 20px;
        spacing: 10px;
        
        Text {
            text: "Library Properties";
            font-size: 18px;
            font-weight: 700;
        }
        
        Rectangle { height: 10px; }
        
        VerticalBox {
            spacing: 8px;
            
            Text {
                text: "Name:";
                font-size: 12px;
            }
            TextInput {
                text <=> root.library-name;
            }
            
            Text {
                text: "Country:";
                font-size: 12px;
            }
            TextInput {
                text: root.library-country;
            }
            
            Text {
                text: "Era:";
                font-size: 12px;
            }
            TextInput {
                text <=> root.library-era;
            }
            
            Text {
                text: "Author:";
                font-size: 12px;
            }
            TextInput {
                text <=> root.library-author;
            }
            
            Text {
                text: "Tags (comma-separated):";
                font-size: 12px;
            }
            TextInput {
                text <=> root.library-tags;
            }
        }
        
        Rectangle { height: 20px; }
        
        HorizontalBox {
            alignment: end;
            spacing: 10px;
            
            Button {
                text: "Cancel";
                clicked => {
                    root.cancelled();
                }
            }
            Button {
                text: "OK";
                clicked => {
                    root.accepted();
                }
            }
        }
    }
}

export component ConfirmDeleteDialog inherits Window {
    width: 420px;
    height: 180px;
    title: root.dialog-title;
    
    in-out property <string> message: "";
    in-out property <string> dialog-title: "Delete library?";
    in-out property <string> cancel-text: "Cancel";
    in-out property <string> delete-text: "Delete";
    
    callback confirmed();
    callback cancelled();
    
    VerticalBox {
        padding: 20px;
        spacing: 16px;
        
        Text {
            text: root.message;
            font-size: 14px;
            wrap: word-wrap;
        }
        
        Rectangle { height: 10px; }
        
        HorizontalBox {
            alignment: end;
            spacing: 10px;
            
            Button {
                text: root.cancel-text;
                clicked => {
                    root.cancelled();
                }
            }
            Button {
                text: root.delete-text;
                clicked => {
                    root.confirmed();
                }
            }
        }
    }
}

export struct BranchRow {
    id: int,
    category-id: int,
    name-ru: string,
    name-en: string,
}

export struct CategoryItem {
    id: int,
    name: string,
}

export struct CategoryRow {
    id: int,
    name-ru: string,
    name-en: string,
}

export struct FormationLevelRow {
    id: int,
    name-ru: string,
    name-en: string,
    standard-level-ordinal: int,
}

export struct OtherLibraryItem {
    id: int,
    name: string,
}

export component FormationLevelsEditor inherits Window {
    width: 640px;
    height: 480px;
    title: root.tr-formation-levels-title;
    
    in-out property <int> library-id: -1;
    in-out property <string> library-name: "";
    in-out property <[FormationLevelRow]> custom-levels: [];
    in-out property <int> current-index: -1;
    in-out property <string> current-name-ru: "";
    in-out property <string> current-name-en: "";
    in-out property <int> current-standard-ordinal: 0;
    in-out property <[string]> standard-level-names: [];
    
    in-out property <string> tr-formation-levels-title: "Formation levels";
    in-out property <string> tr-name-russian: "Name (Russian)";
    in-out property <string> tr-name-english: "Name (English)";
    in-out property <string> tr-corresponds-to: "Corresponds to";
    in-out property <string> tr-add-level: "Add level";
    in-out property <string> tr-delete-level: "Delete level";
    in-out property <string> tr-export: "Export…";
    in-out property <string> tr-import: "Import…";
    in-out property <string> tr-copy-from-library: "Copy from library";
    in-out property <string> tr-close: "Close";
    in-out property <[OtherLibraryItem]> other-libraries: [];
    in-out property <int> copy-source-index: -1;
    
    callback add-level();
    callback delete-level();
    callback export-levels();
    callback import-levels();
    callback copy-from-library();
    callback close-editor();
    callback selection-changed(int);
    callback form-changed(string, string, int);
    
    HorizontalBox {
        Rectangle {
            width: 220px;
            background: #f5f5f5;
            border-width: 1px;
            border-color: #ddd;
            VerticalBox {
                padding: 8px;
                spacing: 4px;
                Text {
                    text: root.tr-formation-levels-title;
                    font-size: 14px;
                    font-weight: 700;
                }
                Rectangle { height: 8px; }
                ScrollView {
                    VerticalBox {
                        for level[index] in root.custom-levels: Rectangle {
                            background: index == root.current-index ? #e0e0e0 : #fff;
                            border-width: 1px;
                            border-color: #ddd;
                            min-height: 32px;
                            HorizontalBox {
                                padding: 6px;
                                Text {
                                    text: level.name-ru;
                                    font-size: 12px;
                                    overflow: elide;
                                }
                            }
                            TouchArea {
                                clicked => { root.selection-changed(index); }
                            }
                        }
                    }
                }
                Rectangle { height: 8px; }
                HorizontalBox {
                    spacing: 6px;
                    Button {
                        min-width: 90px;
                        text: root.tr-add-level;
                        clicked => { root.add-level(); }
                    }
                    Button {
                        min-width: 90px;
                        text: root.tr-delete-level;
                        clicked => { root.delete-level(); }
                    }
                }
            }
        }
        VerticalBox {
            padding: 16px;
            spacing: 12px;
            Text {
                text: root.tr-name-russian;
                font-size: 12px;
                font-weight: 700;
            }
            TextInput {
                text <=> root.current-name-ru;
            }
            Text {
                text: root.tr-name-english;
                font-size: 12px;
                font-weight: 700;
            }
            TextInput {
                text <=> root.current-name-en;
            }
            Text {
                text: root.tr-corresponds-to;
                font-size: 12px;
                font-weight: 700;
            }
            ScrollView {
                max-height: 200px;
                VerticalBox {
                    for standard[index] in root.standard-level-names: Rectangle {
                        background: index == root.current-standard-ordinal ? #d0e0ff : #f9f9f9;
                        border-width: 1px;
                        border-color: #ddd;
                        min-height: 28px;
                        HorizontalBox {
                            padding: 6px;
                            Text {
                                text: standard;
                                font-size: 12px;
                            }
                        }
                        TouchArea {
                            clicked => {
                                root.current-standard-ordinal = index;
                                root.form-changed(root.current-name-ru, root.current-name-en, index);
                            }
                        }
                    }
                }
            }
            Rectangle { }
            Text { text: root.tr-copy-from-library; font-size: 12px; font-weight: 700; }
            ScrollView {
                max-height: 100px;
                VerticalBox {
                    for lib[index] in root.other-libraries: Rectangle {
                        background: index == root.copy-source-index ? #d0e0ff : #f9f9f9;
                        min-height: 24px;
                        HorizontalBox {
                            padding: 4px;
                            Text { text: lib.name; font-size: 12px; }
                        }
                        TouchArea {
                            clicked => { root.copy-source-index = index; }
                        }
                    }
                }
            }
            HorizontalBox {
                spacing: 6px;
                Button {
                    min-width: 100px;
                    text: root.tr-export;
                    clicked => { root.export-levels(); }
                }
                Button {
                    min-width: 100px;
                    text: root.tr-import;
                    clicked => { root.import-levels(); }
                }
                Button {
                    min-width: 140px;
                    text: root.tr-copy-from-library;
                    clicked => { root.copy-from-library(); }
                }
                Rectangle { }
                Button {
                    min-width: 80px;
                    text: root.tr-close;
                    clicked => { root.close-editor(); }
                }
            }
        }
    }
}

export component BranchesEditor inherits Window {
    width: 600px;
    height: 460px;
    title: root.tr-branches-title;
    
    in-out property <int> library-id: -1;
    in-out property <string> library-name: "";
    in-out property <[BranchRow]> branches: [];
    in-out property <int> current-index: -1;
    in-out property <string> current-name-ru: "";
    in-out property <string> current-name-en: "";
    in-out property <[CategoryItem]> categories: [];
    in-out property <int> current-category-index: -1;
    
    in-out property <string> tr-branches-title: "Branches of service";
    in-out property <string> tr-name-russian: "Name (Russian)";
    in-out property <string> tr-name-english: "Name (English)";
    in-out property <string> tr-category: "Category";
    in-out property <string> tr-add: "Add";
    in-out property <string> tr-delete: "Delete";
    in-out property <string> tr-export: "Export…";
    in-out property <string> tr-import: "Import…";
    in-out property <string> tr-copy-from-library: "Copy from library";
    in-out property <string> tr-close: "Close";
    in-out property <[OtherLibraryItem]> other-libraries: [];
    in-out property <int> copy-source-index: -1;
    
    callback add-branch();
    callback delete-branch();
    callback export-branches();
    callback import-branches();
    callback copy-from-library();
    callback close-editor();
    callback selection-changed(int);
    callback category-changed(int);
    
    HorizontalBox {
        Rectangle {
            width: 200px;
            background: #f5f5f5;
            border-width: 1px;
            border-color: #ddd;
            VerticalBox {
                padding: 8px;
                spacing: 4px;
                Text { text: root.tr-branches-title; font-size: 14px; font-weight: 700; }
                Rectangle { height: 8px; }
                ScrollView {
                    VerticalBox {
                        for branch[index] in root.branches: Rectangle {
                            background: index == root.current-index ? #e0e0e0 : #fff;
                            border-width: 1px;
                            border-color: #ddd;
                            min-height: 32px;
                            HorizontalBox {
                                padding: 6px;
                                Text { text: branch.name-ru; font-size: 12px; overflow: elide; }
                            }
                            TouchArea { clicked => { root.selection-changed(index); } }
                        }
                    }
                }
                Rectangle { height: 8px; }
                HorizontalBox {
                    spacing: 6px;
                    Button {
                        min-width: 90px;
                        text: root.tr-add;
                        clicked => { root.add-branch(); }
                    }
                    Button {
                        min-width: 90px;
                        text: root.tr-delete;
                        clicked => { root.delete-branch(); }
                    }
                }
            }
        }
        VerticalBox {
            padding: 16px;
            spacing: 12px;
            Text { text: root.tr-name-russian; font-size: 12px; font-weight: 700; }
            TextInput { text <=> root.current-name-ru; }
            Text { text: root.tr-name-english; font-size: 12px; font-weight: 700; }
            TextInput { text <=> root.current-name-en; }
            Text { text: root.tr-category; font-size: 12px; font-weight: 700; }
            ScrollView {
                max-height: 80px;
                VerticalBox {
                    for cat[index] in root.categories: Rectangle {
                        background: index == root.current-category-index ? #d0e0ff : #f9f9f9;
                        min-height: 24px;
                        HorizontalBox {
                            padding: 4px;
                            Text { text: cat.name; font-size: 12px; }
                        }
                        TouchArea { clicked => { root.category-changed(index); } }
                    }
                }
            }
            Rectangle { }
            Text { text: root.tr-copy-from-library; font-size: 12px; font-weight: 700; }
            ScrollView {
                max-height: 100px;
                VerticalBox {
                    for lib[index] in root.other-libraries: Rectangle {
                        background: index == root.copy-source-index ? #d0e0ff : #f9f9f9;
                        min-height: 24px;
                        HorizontalBox {
                            padding: 4px;
                            Text { text: lib.name; font-size: 12px; }
                        }
                        TouchArea { clicked => { root.copy-source-index = index; } }
                    }
                }
            }
            HorizontalBox {
                spacing: 6px;
                Button {
                    min-width: 100px;
                    text: root.tr-export;
                    clicked => { root.export-branches(); }
                }
                Button {
                    min-width: 100px;
                    text: root.tr-import;
                    clicked => { root.import-branches(); }
                }
                Button {
                    min-width: 140px;
                    text: root.tr-copy-from-library;
                    clicked => { root.copy-from-library(); }
                }
                Rectangle { }
                Button {
                    min-width: 80px;
                    text: root.tr-close;
                    clicked => { root.close-editor(); }
                }
            }
        }
    }
}

export component BranchCategoriesEditor inherits Window {
    width: 600px;
    height: 460px;
    title: root.tr-categories-title;
    
    in-out property <int> library-id: -1;
    in-out property <string> library-name: "";
    in-out property <[CategoryRow]> categories: [];
    in-out property <int> current-index: -1;
    in-out property <string> current-name-ru: "";
    in-out property <string> current-name-en: "";
    
    in-out property <string> tr-categories-title: "Branch categories";
    in-out property <string> tr-name-russian: "Name (Russian)";
    in-out property <string> tr-name-english: "Name (English)";
    in-out property <string> tr-add: "Add";
    in-out property <string> tr-delete: "Delete";
    in-out property <string> tr-export: "Export…";
    in-out property <string> tr-import: "Import…";
    in-out property <string> tr-copy-from-library: "Copy from library";
    in-out property <string> tr-close: "Close";
    in-out property <[OtherLibraryItem]> other-libraries: [];
    in-out property <int> copy-source-index: -1;
    
    callback add-category();
    callback delete-category();
    callback export-categories();
    callback import-categories();
    callback copy-from-library();
    callback close-editor();
    callback selection-changed(int);
    
    HorizontalBox {
        Rectangle {
            width: 200px;
            background: #f5f5f5;
            border-width: 1px;
            border-color: #ddd;
            VerticalBox {
                padding: 8px;
                spacing: 4px;
                Text { text: root.tr-categories-title; font-size: 14px; font-weight: 700; }
                Rectangle { height: 8px; }
                ScrollView {
                    VerticalBox {
                        for cat[index] in root.categories: Rectangle {
                            background: index == root.current-index ? #e0e0e0 : #fff;
                            border-width: 1px;
                            border-color: #ddd;
                            min-height: 32px;
                            HorizontalBox {
                                padding: 6px;
                                Text { text: cat.name-ru; font-size: 12px; overflow: elide; }
                            }
                            TouchArea { clicked => { root.selection-changed(index); } }
                        }
                    }
                }
                Rectangle { height: 8px; }
                HorizontalBox {
                    spacing: 6px;
                    Button {
                        min-width: 90px;
                        text: root.tr-add;
                        clicked => { root.add-category(); }
                    }
                    Button {
                        min-width: 90px;
                        text: root.tr-delete;
                        clicked => { root.delete-category(); }
                    }
                }
            }
        }
        VerticalBox {
            padding: 16px;
            spacing: 12px;
            Text { text: root.tr-name-russian; font-size: 12px; font-weight: 700; }
            TextInput { text <=> root.current-name-ru; }
            Text { text: root.tr-name-english; font-size: 12px; font-weight: 700; }
            TextInput { text <=> root.current-name-en; }
            Rectangle { }
            Text { text: root.tr-copy-from-library; font-size: 12px; font-weight: 700; }
            ScrollView {
                max-height: 100px;
                VerticalBox {
                    for lib[index] in root.other-libraries: Rectangle {
                        background: index == root.copy-source-index ? #d0e0ff : #f9f9f9;
                        min-height: 24px;
                        HorizontalBox {
                            padding: 4px;
                            Text { text: lib.name; font-size: 12px; }
                        }
                        TouchArea { clicked => { root.copy-source-index = index; } }
                    }
                }
            }
            HorizontalBox {
                spacing: 6px;
                Button {
                    min-width: 100px;
                    text: root.tr-export;
                    clicked => { root.export-categories(); }
                }
                Button {
                    min-width: 100px;
                    text: root.tr-import;
                    clicked => { root.import-categories(); }
                }
                Button {
                    min-width: 140px;
                    text: root.tr-copy-from-library;
                    clicked => { root.copy-from-library(); }
                }
                Rectangle { }
                Button {
                    min-width: 80px;
                    text: root.tr-close;
                    clicked => { root.close-editor(); }
                }
            }
        }
    }
}

export component LibraryContextMenu inherits Window {
    width: 200px;
    height: 140px;
    title: "";
    no-frame: true;
    in-out property <int> library-id: -1;
    callback properties();
    callback export-library();
    callback history();
    callback delete-library();
    callback cancelled();
    Rectangle {
        background: #ffffff;
        border-width: 1px;
        border-color: #999;
        VerticalBox {
            padding: 4px;
            TouchArea {
                height: 28px;
                HorizontalBox {
                    padding: 8px;
                    Text { text: "Properties…"; font-size: 12px; }
                }
                clicked => { root.properties(); }
            }
            TouchArea {
                height: 28px;
                HorizontalBox {
                    padding: 8px;
                    Text { text: "Export…"; font-size: 12px; }
                }
                clicked => { root.export-library(); }
            }
            TouchArea {
                height: 28px;
                HorizontalBox {
                    padding: 8px;
                    Text { text: "View history…"; font-size: 12px; }
                }
                clicked => { root.history(); }
            }
            Rectangle { height: 2px; background: #ddd; }
            TouchArea {
                height: 28px;
                HorizontalBox {
                    padding: 8px;
                    Text { text: "Delete"; font-size: 12px; }
                }
                clicked => { root.delete-library(); }
            }
        }
    }
}

export struct ToolbarButton {
    id: string,
    icon: string,
    tooltip: string,
    enabled: bool,
    is-separator: bool,
}

export struct LibraryItem {
    id: int,
    name: string,
    country: string,
    era: string,
}

export struct FormationTab {
    id: int,
    title: string,
    view-mode: string, // "table" | "diagram" | "both"
}

export struct FormationTreeItem {
    id: int,
    name: string,
    depth: int,
}

export component MainWindow inherits Window {
    title: root.window-title;
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 800px;
    min-height: 600px;
    background: root.color-bg-main;

    in-out property <[ToolbarButton]> toolbar: [];
    in-out property <string> window-title: @tr("TOEditor");
    in-out property <bool> sidebar-visible: true;
    in-out property <string> current-language: "en";
    in-out property <[LibraryItem]> libraries: [];
    in-out property <string> current-library-name: "";
    in-out property <int> current-library-id: -1;
    in-out property <bool> libraries-sidebar-expanded: true;
    in-out property <bool> formations-sidebar-expanded: true;
    in-out property <[FormationTreeItem]> formations: [];
    in-out property <[FormationTab]> open-tabs: [];
    in-out property <int> current-tab-index: -1;
    in-out property <string> current-tab-title: "";
    in-out property <string> current-tab-view-mode: "table";
    
    // Theme properties
    in-out property <string> theme: "light"; // "light" or "dark"
    
    // Color theme variables (light theme - Variant #2, dark theme - wet asphalt)
    property <color> color-bg-main: root.theme == "dark" ? #34495e : #f5f5f5;
    property <color> color-bg-toolbar: root.theme == "dark" ? #3d566e : #e8e8e8;
    property <color> color-bg-sidebar: root.theme == "dark" ? #3d566e : #f0f0f0;
    property <color> color-bg-sidebar-alt: root.theme == "dark" ? #465a6f : #e8e8e8;
    property <color> color-bg-content: root.theme == "dark" ? #34495e : #ffffff;
    property <color> color-bg-list: root.theme == "dark" ? #3d566e : #ffffff;
    property <color> color-bg-tab-active: root.theme == "dark" ? #3d566e : #ffffff;
    property <color> color-bg-tab-inactive: root.theme == "dark" ? #465a6f : #d0d0d0;
    property <color> color-bg-selected: root.theme == "dark" ? #4a6fa5 : #e0e0e0;
    property <color> color-bg-hover: root.theme == "dark" ? #465a6f : #f0f0f0;
    
    property <color> color-text-primary: root.theme == "dark" ? #ecf0f1 : #1f2937;
    property <color> color-text-secondary: root.theme == "dark" ? #bdc3c7 : #6b7280;
    
    property <color> color-accent: root.theme == "dark" ? #3498db : #2563eb;
    property <color> color-accent-hover: root.theme == "dark" ? #5dade2 : #3b82f6;
    
    property <color> color-border: root.theme == "dark" ? #4a5f7a : #d1d5db;
    property <color> color-border-light: root.theme == "dark" ? #465a6f : #e5e7eb;
    property <color> color-separator: root.theme == "dark" ? #4a5f7a : #bbb;

    // Strings set from Rust so they update when language changes
    in-out property <string> tr-new-library: "New Library";
    in-out property <string> tr-open-library: "Open Library";
    in-out property <string> tr-save-library: "Save Library";
    in-out property <string> tr-language: "Language";
    in-out property <string> tr-libraries: "Libraries";
    in-out property <string> tr-welcome-title: "Welcome to TOEditor";
    in-out property <string> tr-welcome-desc: "Create a new library or open an existing one to get started.";

    // Menu strings (set from Rust when language changes)
    in-out property <string> tr-file: "File";
    in-out property <string> tr-open-library-ellipsis: "Open Library…";
    in-out property <string> tr-recent-libraries: "Recent Libraries";
    in-out property <string> tr-save-library-as: "Save Library As…";
    in-out property <string> tr-import: "Import";
    in-out property <string> tr-import-library-from-file: "Import Library from File…";
    in-out property <string> tr-import-formation-from-file: "Import Formation from File…";
    in-out property <string> tr-export: "Export";
    in-out property <string> tr-export-library-ellipsis: "Export Library…";
    in-out property <string> tr-export-selected-formation: "Export Selected Formation…";
    in-out property <string> tr-export-as-spreadsheet: "Export as Spreadsheet…";
    in-out property <string> tr-export-diagram: "Export Diagram…";
    in-out property <string> tr-exit: "Exit";
    in-out property <string> tr-edit: "Edit";
    in-out property <string> tr-find: "Find";
    in-out property <string> tr-find-and-replace: "Find and Replace";
    in-out property <string> tr-undo: "Undo";
    in-out property <string> tr-redo: "Redo";
    in-out property <string> tr-cut: "Cut";
    in-out property <string> tr-copy: "Copy";
    in-out property <string> tr-paste: "Paste";
    in-out property <string> tr-delete: "Delete";
    in-out property <string> tr-add-new-formation: "Add New Formation…";
    in-out property <string> tr-edit-properties: "Edit Properties…";
    in-out property <string> tr-library: "Library";
    in-out property <string> tr-positions-and-ranks-editor: "Positions and Ranks Editor…";
    in-out property <string> tr-equipment-and-vehicles-editor: "Equipment and Vehicles Editor…";
    in-out property <string> tr-formation-levels: "Formation levels…";
    in-out property <string> tr-branches: "Branches…";
    in-out property <string> tr-branch-categories: "Branch categories…";
    in-out property <string> tr-library-properties: "Library Properties…";
    in-out property <string> tr-manage-tags: "Manage Tags…";
    in-out property <string> tr-version-control: "Version Control";
    in-out property <string> tr-view-history: "View History…";
    in-out property <string> tr-create-snapshot: "Create Snapshot (Commit)…";
    in-out property <string> tr-compare-versions: "Compare Versions…";
    in-out property <string> tr-revert-to-version: "Revert to Version…";
    in-out property <string> tr-unit: "Unit";
    in-out property <string> tr-add-child-formation: "Add Child Formation…";
    in-out property <string> tr-delete-this-formation: "Delete This Formation";
    in-out property <string> tr-move-up: "Move Up";
    in-out property <string> tr-move-down: "Move Down";
    in-out property <string> tr-summary-table: "Summary Table";
    in-out property <string> tr-export-this-formation: "Export This Formation…";
    in-out property <string> tr-view: "View";
    in-out property <string> tr-view-mode: "View Mode";
    in-out property <string> tr-table: "Table";
    in-out property <string> tr-diagram: "Diagram";
    in-out property <string> tr-table-and-diagram: "Table and Diagram";
    in-out property <string> tr-tactical-symbols: "Tactical Symbols";
    in-out property <string> tr-nato-app6: "NATO (APP-6)";
    in-out property <string> tr-russia-gost: "Russia (ГОСТ РВ)";
    in-out property <string> tr-load-custom-set: "Load Custom Set…";
    in-out property <string> tr-color-scheme: "Color Scheme…";
    in-out property <string> tr-light: "Light";
    in-out property <string> tr-dark: "Dark";
    in-out property <string> tr-show-equipment-images: "Show Equipment Images";
    in-out property <string> tr-zoom: "Zoom";
    in-out property <string> tr-zoom-in: "Zoom In";
    in-out property <string> tr-zoom-out: "Zoom Out";
    in-out property <string> tr-reset-zoom: "Reset Zoom";
    in-out property <string> tr-refresh: "Refresh";
    in-out property <string> tr-tools: "Tools";
    in-out property <string> tr-settings: "Settings…";
    in-out property <string> tr-interface-language: "Interface Language";
    in-out property <string> tr-english: "English";
    in-out property <string> tr-russian: "Russian";
    in-out property <string> tr-data-paths: "Data Paths…";
    in-out property <string> tr-reset-settings: "Reset Settings";
    in-out property <string> tr-help: "Help";
    in-out property <string> tr-user-guide: "User Guide";
    in-out property <string> tr-about-toeditor: "About TOEditor…";
    in-out property <string> tr-check-for-updates: "Check for Updates";

    // File menu callbacks
    callback file-new-library();
    callback file-open-library();
    callback file-recent-libraries();
    callback file-save-library();
    callback file-save-library-as();
    callback file-import-library();
    callback file-import-formation();
    callback file-export-library();
    callback file-export-formation();
    callback file-export-spreadsheet();
    callback file-export-diagram();
    callback file-exit();

    // Edit menu callbacks
    callback edit-find();
    callback edit-find-replace();
    callback edit-undo();
    callback edit-redo();
    callback edit-cut();
    callback edit-copy();
    callback edit-paste();
    callback edit-delete();
    callback edit-add-formation();
    callback edit-edit-properties();

    // Library menu callbacks
    callback library-positions-editor();
    callback library-equipment-editor();
    callback library-formation-levels();
    callback library-branches();
    callback library-branch-categories();
    callback library-properties();
    callback library-manage-tags();
    callback library-export-library();
    callback library-view-history();
    callback library-create-snapshot();
    callback library-compare-versions();
    callback library-revert-to-version();
    callback library-delete();
    
    // Library dialog callbacks
    callback show-library-dialog(string, int); // mode: "new" or "edit", library_id for edit
    callback library-dialog-accepted(string, string, string, string, string, int); // name, country, era, author, tags, library_id (-1 for new)
    callback library-dialog-cancelled();

    // Unit menu callbacks
    callback unit-add-child();
    callback unit-delete();
    callback unit-move-up();
    callback unit-move-down();
    callback unit-summary-table();
    callback unit-export();
    callback unit-view-history();
    callback unit-create-snapshot();
    callback unit-compare-versions();
    callback unit-revert-to-version();

    // View menu callbacks
    callback view-table();
    callback view-diagram();
    callback view-table-and-diagram();
    callback view-symbols-nato();
    callback view-symbols-russia();
    callback view-load-symbols();
    callback view-color-scheme();
    callback switch-theme(string); // "light" or "dark"
    callback view-show-images();
    callback view-zoom-in();
    callback view-zoom-out();
    callback view-zoom-reset();
    callback view-refresh();

    // Tools menu callbacks
    callback tools-settings();
    callback tools-language();
    callback tools-data-paths();
    callback tools-reset-settings();

    // Help menu callbacks
    callback help-user-guide();
    callback help-about();
    callback help-check-updates();

    // Language switching
    callback switch-language(string);
    callback switch-to-english();
    callback switch-to-russian();

    // Library selection and context menu
    callback library-selected(int);
    callback library-right-clicked(int, int);
    callback toggle-libraries-sidebar();
    callback toggle-formations-sidebar();
    // Formations tree
    callback formation-open(int);
    // Tabs
    callback tab-select(int);
    callback tab-close(int);
    callback tab-set-view-mode(int, string);

    MenuBar {
        Menu {
            title: root.tr-file;
            MenuItem {
                title: root.tr-new-library;
                activated => { root.file-new-library(); }
            }
            MenuItem {
                title: root.tr-open-library-ellipsis;
                activated => { root.file-open-library(); }
            }
            MenuItem {
                title: root.tr-recent-libraries;
                activated => { root.file-recent-libraries(); }
            }
            MenuSeparator {}
            MenuItem {
                title: root.tr-save-library;
                activated => { root.file-save-library(); }
            }
            MenuItem {
                title: root.tr-save-library-as;
                activated => { root.file-save-library-as(); }
            }
            MenuSeparator {}
            Menu {
                title: root.tr-import;
                MenuItem {
                    title: root.tr-import-library-from-file;
                    activated => { root.file-import-library(); }
                }
                MenuItem {
                    title: root.tr-import-formation-from-file;
                    activated => { root.file-import-formation(); }
                }
            }
            Menu {
                title: root.tr-export;
                MenuItem {
                    title: root.tr-export-library-ellipsis;
                    activated => { root.file-export-library(); }
                }
                MenuItem {
                    title: root.tr-export-selected-formation;
                    activated => { root.file-export-formation(); }
                }
                MenuItem {
                    title: root.tr-export-as-spreadsheet;
                    activated => { root.file-export-spreadsheet(); }
                }
                MenuItem {
                    title: root.tr-export-diagram;
                    activated => { root.file-export-diagram(); }
                }
            }
            MenuSeparator {}
            MenuItem {
                title: root.tr-exit;
                activated => { root.file-exit(); }
            }
        }
        Menu {
            title: root.tr-edit;
            MenuItem {
                title: root.tr-find;
                activated => { root.edit-find(); }
            }
            MenuItem {
                title: root.tr-find-and-replace;
                activated => { root.edit-find-replace(); }
            }
            MenuSeparator {}
            MenuItem {
                title: root.tr-undo;
                activated => { root.edit-undo(); }
            }
            MenuItem {
                title: root.tr-redo;
                activated => { root.edit-redo(); }
            }
            MenuSeparator {}
            MenuItem {
                title: root.tr-cut;
                activated => { root.edit-cut(); }
            }
            MenuItem {
                title: root.tr-copy;
                activated => { root.edit-copy(); }
            }
            MenuItem {
                title: root.tr-paste;
                activated => { root.edit-paste(); }
            }
            MenuItem {
                title: root.tr-delete;
                activated => { root.edit-delete(); }
            }
            MenuSeparator {}
            MenuItem {
                title: root.tr-add-new-formation;
                activated => { root.edit-add-formation(); }
            }
            MenuItem {
                title: root.tr-edit-properties;
                activated => { root.edit-edit-properties(); }
            }
        }
        Menu {
            title: root.tr-library;
            MenuItem {
                title: root.tr-positions-and-ranks-editor;
                activated => { root.library-positions-editor(); }
            }
            MenuItem {
                title: root.tr-equipment-and-vehicles-editor;
                activated => { root.library-equipment-editor(); }
            }
            MenuItem {
                title: root.tr-formation-levels;
                activated => { root.library-formation-levels(); }
            }
            MenuItem {
                title: root.tr-branches;
                activated => { root.library-branches(); }
            }
            MenuItem {
                title: root.tr-branch-categories;
                activated => { root.library-branch-categories(); }
            }
            MenuItem {
                title: root.tr-library-properties;
                activated => { root.library-properties(); }
            }
            MenuItem {
                title: root.tr-manage-tags;
                activated => { root.library-manage-tags(); }
            }
            MenuItem {
                title: root.tr-export-library-ellipsis;
                activated => { root.library-export-library(); }
            }
            MenuSeparator {}
            Menu {
                title: root.tr-version-control;
                MenuItem {
                    title: root.tr-view-history;
                    activated => { root.library-view-history(); }
                }
                MenuItem {
                    title: root.tr-create-snapshot;
                    activated => { root.library-create-snapshot(); }
                }
                MenuItem {
                    title: root.tr-compare-versions;
                    activated => { root.library-compare-versions(); }
                }
                MenuItem {
                    title: root.tr-revert-to-version;
                    activated => { root.library-revert-to-version(); }
                }
            }
        }
        Menu {
            title: root.tr-unit;
            MenuItem {
                title: root.tr-add-child-formation;
                activated => { root.unit-add-child(); }
            }
            MenuItem {
                title: root.tr-delete-this-formation;
                activated => { root.unit-delete(); }
            }
            MenuItem {
                title: root.tr-move-up;
                activated => { root.unit-move-up(); }
            }
            MenuItem {
                title: root.tr-move-down;
                activated => { root.unit-move-down(); }
            }
            MenuItem {
                title: root.tr-summary-table;
                activated => { root.unit-summary-table(); }
            }
            MenuItem {
                title: root.tr-export-this-formation;
                activated => { root.unit-export(); }
            }
            MenuSeparator {}
            Menu {
                title: root.tr-version-control;
                MenuItem {
                    title: root.tr-view-history;
                    activated => { root.unit-view-history(); }
                }
                MenuItem {
                    title: root.tr-create-snapshot;
                    activated => { root.unit-create-snapshot(); }
                }
                MenuItem {
                    title: root.tr-compare-versions;
                    activated => { root.unit-compare-versions(); }
                }
                MenuItem {
                    title: root.tr-revert-to-version;
                    activated => { root.unit-revert-to-version(); }
                }
            }
        }
        Menu {
            title: root.tr-view;
            Menu {
                title: root.tr-view-mode;
                MenuItem {
                    title: root.tr-table;
                    activated => { root.view-table(); }
                }
                MenuItem {
                    title: root.tr-diagram;
                    activated => { root.view-diagram(); }
                }
                MenuItem {
                    title: root.tr-table-and-diagram;
                    activated => { root.view-table-and-diagram(); }
                }
            }
            MenuSeparator {}
            Menu {
                title: root.tr-tactical-symbols;
                MenuItem {
                    title: root.tr-nato-app6;
                    activated => { root.view-symbols-nato(); }
                }
                MenuItem {
                    title: root.tr-russia-gost;
                    activated => { root.view-symbols-russia(); }
                }
                MenuItem {
                    title: root.tr-load-custom-set;
                    activated => { root.view-load-symbols(); }
                }
            }
            Menu {
                title: root.tr-color-scheme;
                MenuItem {
                    title: root.tr-light;
                    activated => { root.switch-theme("light"); }
                }
                MenuItem {
                    title: root.tr-dark;
                    activated => { root.switch-theme("dark"); }
                }
            }
            MenuItem {
                title: root.tr-show-equipment-images;
                activated => { root.view-show-images(); }
            }
            MenuSeparator {}
            Menu {
                title: root.tr-zoom;
                MenuItem {
                    title: root.tr-zoom-in;
                    activated => { root.view-zoom-in(); }
                }
                MenuItem {
                    title: root.tr-zoom-out;
                    activated => { root.view-zoom-out(); }
                }
                MenuItem {
                    title: root.tr-reset-zoom;
                    activated => { root.view-zoom-reset(); }
                }
            }
            MenuItem {
                title: root.tr-refresh;
                activated => { root.view-refresh(); }
            }
        }
        Menu {
            title: root.tr-tools;
            MenuItem {
                title: root.tr-settings;
                activated => { root.tools-settings(); }
            }
            Menu {
                title: root.tr-interface-language;
                MenuItem {
                    title: root.tr-english;
                    activated => { 
                        root.switch-language("en");
                        root.switch-to-english();
                    }
                }
                MenuItem {
                    title: root.tr-russian;
                    activated => { 
                        root.switch-language("ru");
                        root.switch-to-russian();
                    }
                }
            }
            MenuItem {
                title: root.tr-data-paths;
                activated => { root.tools-data-paths(); }
            }
            MenuItem {
                title: root.tr-reset-settings;
                activated => { root.tools-reset-settings(); }
            }
        }
        Menu {
            title: root.tr-help;
            MenuItem {
                title: root.tr-user-guide;
                activated => { root.help-user-guide(); }
            }
            MenuItem {
                title: root.tr-about-toeditor;
                activated => { root.help-about(); }
            }
            MenuItem {
                title: root.tr-check-for-updates;
                activated => { root.help-check-updates(); }
            }
        }
    }

    VerticalBox {
        // Toolbar
        Rectangle {
            height: 40px;
            background: root.color-bg-toolbar;
            HorizontalBox {
                padding: 5px;
                spacing: 5px;
                Button {
                    text: root.tr-save-library;
                    enabled: false;
                    clicked => { root.file-save-library(); }
                }
                Rectangle { width: 2px; background: root.color-separator; }
                Text { 
                    text: root.tr-language; 
                    vertical-alignment: center;
                    color: root.color-text-primary;
                }
                Button {
                    text: "EN";
                    clicked => {
                        root.switch-language("en");
                        root.switch-to-english();
                    }
                }
                Button {
                    text: "RU";
                    clicked => {
                        root.switch-language("ru");
                        root.switch-to-russian();
                    }
                }
            }
        }

        // Main content: two collapsible sidebars + center with tabs
        HorizontalBox {
            // === Left: Collapsible Libraries sidebar ===
            Rectangle {
                width: root.libraries-sidebar-expanded ? 220px : 28px;
                background: root.color-bg-sidebar;
                border-width: 1px;
                border-color: root.color-border;
                VerticalBox {
                    if root.libraries-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        HorizontalBox {
                            Text {
                                text: root.tr-libraries;
                                font-size: 14px;
                                font-weight: 700;
                                vertical-alignment: center;
                                color: root.color-text-primary;
                            }
                            Rectangle { width: 1px; }
                            TouchArea {
                                width: 20px;
                                height: 20px;
                                Text {
                                    text: "◀";
                                    font-size: 11px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                                clicked => { root.toggle-libraries-sidebar(); }
                            }
                        }
                        Rectangle { height: 8px; }
                        Rectangle {
                            background: root.color-bg-list;
                            border-width: 1px;
                            border-color: root.color-border-light;
                            ScrollView {
                                Rectangle {
                                    background: root.color-bg-list;
                                    VerticalBox {
                                        for library[index] in root.libraries: Rectangle {
                                            height: 28px;
                                            background: library.id == root.current-library-id ? root.color-bg-selected : root.color-bg-list;
                                            HorizontalBox {
                                                padding: 4px;
                                                Text {
                                                    text: library.name;
                                                    font-size: 12px;
                                                    overflow: elide;
                                                    color: root.color-text-primary;
                                                }
                                            }
                                            touch-lib := TouchArea {
                                                clicked => {
                                                    root.library-selected(library.id);
                                                }
                                                pointer-event(event) => {
                                                    if (event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                                                        root.library-right-clicked(library.id, index);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        Rectangle { }
                    }
                    if !root.libraries-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        TouchArea {
                            width: 24px;
                            height: 24px;
                            Text {
                                text: "▶";
                                font-size: 12px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                            clicked => { root.toggle-libraries-sidebar(); }
                        }
                        Rectangle { }
                    }
                }
            }

            // === Collapsible Formations sidebar (only when library open) ===
            if root.current-library-id >= 0: Rectangle {
                width: root.formations-sidebar-expanded ? 200px : 28px;
                background: root.color-bg-sidebar-alt;
                border-width: 1px;
                border-color: root.color-border;
                HorizontalBox {
                    if root.formations-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        HorizontalBox {
                            Text {
                                text: root.tr-unit;
                                font-size: 14px;
                                font-weight: 700;
                                vertical-alignment: center;
                                color: root.color-text-primary;
                            }
                            Rectangle { width: 1px; }
                            TouchArea {
                                width: 20px;
                                height: 20px;
                                Text {
                                    text: "◀";
                                    font-size: 11px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                                clicked => { root.toggle-formations-sidebar(); }
                            }
                        }
                        Rectangle { height: 8px; }
                        Rectangle {
                            background: root.color-bg-list;
                            border-width: 1px;
                            border-color: root.color-border-light;
                            ScrollView {
                                Rectangle {
                                    background: root.color-bg-list;
                                    VerticalBox {
                                        for formation[index] in root.formations: Rectangle {
                                            height: 26px;
                                            HorizontalBox {
                                                padding-left: formation.depth * 12px + 4px;
                                                padding-top: 4px;
                                                padding-bottom: 4px;
                                                Text {
                                                    text: formation.name;
                                                    font-size: 12px;
                                                    overflow: elide;
                                                    color: root.color-text-primary;
                                                }
                                            }
                                            touch-form := TouchArea {
                                                clicked => {
                                                    root.formation-open(formation.id);
                                                }
                                            }
                                        }
                                        if root.formations.length == 0: Rectangle {
                                            height: 60px;
                                            Text {
                                                text: root.tr-welcome-desc;
                                                font-size: 11px;
                                                wrap: word-wrap;
                                                color: root.color-text-secondary;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        Rectangle { }
                    }
                    if !root.formations-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        TouchArea {
                            width: 24px;
                            height: 24px;
                            Text {
                                text: "▶";
                                font-size: 12px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                            clicked => { root.toggle-formations-sidebar(); }
                        }
                        Rectangle { }
                    }
                }
            }

            // === Center: Tab bar + content ===
            VerticalBox {
                // Tab bar
                Rectangle {
                    height: 32px;
                    background: root.color-bg-toolbar;
                    border-width: 1px;
                    border-color: root.color-border;
                    HorizontalBox {
                        padding: 4px;
                        spacing: 2px;
                        for tab[index] in root.open-tabs: Rectangle {
                            height: 28px;
                            min-width: 80px;
                            background: index == root.current-tab-index ? #fff : #d0d0d0;
                            border-width: 1px;
                            border-color: #bbb;
                            HorizontalBox {
                                padding: 6px;
                                TouchArea {
                                    Text {
                                        text: tab.title;
                                        font-size: 12px;
                                        overflow: elide;
                                        vertical-alignment: center;
                                        color: root.color-text-primary;
                                    }
                                    clicked => { root.tab-select(index); }
                                }
                                Rectangle { width: 4px; }
                                TouchArea {
                                    width: 18px;
                                    height: 18px;
                                    Text {
                                        text: "×";
                                        font-size: 14px;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                    clicked => { root.tab-close(index); }
                                }
                            }
                        }
                    }
                }
                // Tab content area
                Rectangle {
                    background: root.color-bg-content;
                    border-width: 1px;
                    border-color: root.color-border-light;
                    VerticalBox {
                        Rectangle { }
                        if root.open-tabs.length == 0: VerticalBox {
                            padding: 40px;
                            alignment: center;
                            Text {
                                text: root.tr-welcome-title;
                                font-size: 22px;
                                font-weight: 700;
                                color: root.color-text-primary;
                            }
                            Rectangle { height: 12px; }
                            Text {
                                text: root.tr-welcome-desc;
                                font-size: 14px;
                                color: root.color-text-secondary;
                            }
                        }
                        if root.open-tabs.length > 0 && root.current-tab-index >= 0: VerticalBox {
                            padding: 8px;
                            // View mode selector for current tab
                            HorizontalBox {
                                spacing: 8px;
                                padding-bottom: 8px;
                                Button {
                                    text: root.tr-table;
                                    clicked => { root.tab-set-view-mode(root.current-tab-index, "table"); }
                                }
                                Button {
                                    text: root.tr-diagram;
                                    clicked => { root.tab-set-view-mode(root.current-tab-index, "diagram"); }
                                }
                                Button {
                                    text: root.tr-table-and-diagram;
                                    clicked => { root.tab-set-view-mode(root.current-tab-index, "both"); }
                                }
                            }
                            Rectangle {
                                background: root.color-bg-content;
                                VerticalBox {
                                    padding: 16px;
                                    Text {
                                        text: root.current-tab-view-mode == "table" ? (root.tr-table + " — " + root.current-tab-title) : (root.current-tab-view-mode == "diagram" ? (root.tr-diagram + " — " + root.current-tab-title) : (root.tr-table-and-diagram + " — " + root.current-tab-title));
                                        font-size: 14px;
                                        color: root.color-text-primary;
                                    }
                                }
                            }
                        }
                    }
                }
            }

        }
    }
}
