// Main application window
// Components are split into separate files for maintainability.

import { Button, VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";
import { AppTheme } from "theme.slint";

// Re-export components from submodules so Rust's slint::include_modules!() can see them
export { AppTheme } from "theme.slint";
export { LibraryDialog, ConfirmDeleteDialog, ErrorDialog } from "dialogs.slint";
export { BranchesEditor, BranchCategoriesEditor, FormationLevelsEditor,
         BranchRow, CategoryItem, CategoryRow, FormationLevelRow, OtherLibraryItem } from "editors.slint";
export { LibraryContextMenu } from "context_menu.slint";

export struct ToolbarButton {
    id: string,
    text: string,
    icon: string,
    tooltip: string,
    enabled: bool,
    is-separator: bool,
}

export struct LibraryItem {
    id: int,
    name: string,
    country: string,
    era: string,
}

export struct FormationTab {
    id: int,
    title: string,
    view-mode: string,
}

export struct FormationTreeItem {
    id: int,
    name: string,
    depth: int,
}

export component MainWindow inherits Window {
    title: root.window-title;
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 800px;
    min-height: 600px;
    background: AppTheme.bg-main;

    in-out property <[ToolbarButton]> toolbar: [];
    in-out property <string> window-title: @tr("TOEditor");
    in-out property <bool> sidebar-visible: true;
    in-out property <string> current-language: "en";
    in-out property <[LibraryItem]> libraries: [];
    in-out property <string> current-library-name: "";
    in-out property <int> current-library-id: -1;
    in-out property <bool> libraries-sidebar-expanded: true;
    in-out property <bool> formations-sidebar-expanded: true;
    in-out property <[FormationTreeItem]> formations: [];
    in-out property <[FormationTab]> open-tabs: [];
    in-out property <int> current-tab-index: -1;
    in-out property <string> current-tab-title: "";
    in-out property <string> current-tab-view-mode: "table";

    // Theme property (drives AppTheme global)
    in-out property <string> theme: "light";

    // Strings set from Rust so they update when language changes
    in-out property <string> tr-new-library: "New Library";
    in-out property <string> tr-open-library: "Open Library";
    in-out property <string> tr-save-library: "Save Library";
    in-out property <string> tr-language: "Language";
    in-out property <string> tr-libraries: "Libraries";
    in-out property <string> tr-welcome-title: "Welcome to TOEditor";
    in-out property <string> tr-welcome-desc: "Create a new library or open an existing one to get started.";

    // Menu strings (set from Rust when language changes)
    in-out property <string> tr-file: "File";
    in-out property <string> tr-open-library-ellipsis: "Open Library…";
    in-out property <string> tr-recent-libraries: "Recent Libraries";
    in-out property <string> tr-save-library-as: "Save Library As…";
    in-out property <string> tr-import: "Import";
    in-out property <string> tr-import-library-from-file: "Import Library from File…";
    in-out property <string> tr-import-formation-from-file: "Import Formation from File…";
    in-out property <string> tr-export: "Export";
    in-out property <string> tr-export-library-ellipsis: "Export Library…";
    in-out property <string> tr-export-selected-formation: "Export Selected Formation…";
    in-out property <string> tr-export-as-spreadsheet: "Export as Spreadsheet…";
    in-out property <string> tr-export-diagram: "Export Diagram…";
    in-out property <string> tr-exit: "Exit";
    in-out property <string> tr-edit: "Edit";
    in-out property <string> tr-find: "Find";
    in-out property <string> tr-find-and-replace: "Find and Replace";
    in-out property <string> tr-undo: "Undo";
    in-out property <string> tr-redo: "Redo";
    in-out property <string> tr-cut: "Cut";
    in-out property <string> tr-copy: "Copy";
    in-out property <string> tr-paste: "Paste";
    in-out property <string> tr-delete: "Delete";
    in-out property <string> tr-add-new-formation: "Add New Formation…";
    in-out property <string> tr-edit-properties: "Edit Properties…";
    in-out property <string> tr-library: "Library";
    in-out property <string> tr-positions-and-ranks-editor: "Positions and Ranks Editor…";
    in-out property <string> tr-equipment-and-vehicles-editor: "Equipment and Vehicles Editor…";
    in-out property <string> tr-formation-levels: "Formation levels…";
    in-out property <string> tr-branches: "Branches…";
    in-out property <string> tr-branch-categories: "Branch categories…";
    in-out property <string> tr-library-properties: "Library Properties…";
    in-out property <string> tr-manage-tags: "Manage Tags…";
    in-out property <string> tr-version-control: "Version Control";
    in-out property <string> tr-view-history: "View History…";
    in-out property <string> tr-create-snapshot: "Create Snapshot (Commit)…";
    in-out property <string> tr-compare-versions: "Compare Versions…";
    in-out property <string> tr-revert-to-version: "Revert to Version…";
    in-out property <string> tr-unit: "Unit";
    in-out property <string> tr-add-child-formation: "Add Child Formation…";
    in-out property <string> tr-delete-this-formation: "Delete This Formation";
    in-out property <string> tr-move-up: "Move Up";
    in-out property <string> tr-move-down: "Move Down";
    in-out property <string> tr-summary-table: "Summary Table";
    in-out property <string> tr-export-this-formation: "Export This Formation…";
    in-out property <string> tr-view: "View";
    in-out property <string> tr-view-mode: "View Mode";
    in-out property <string> tr-table: "Table";
    in-out property <string> tr-diagram: "Diagram";
    in-out property <string> tr-table-and-diagram: "Table and Diagram";
    in-out property <string> tr-tactical-symbols: "Tactical Symbols";
    in-out property <string> tr-nato-app6: "NATO (APP-6)";
    in-out property <string> tr-russia-gost: "Russia (ГОСТ РВ)";
    in-out property <string> tr-load-custom-set: "Load Custom Set…";
    in-out property <string> tr-color-scheme: "Color Scheme…";
    in-out property <string> tr-light: "Light";
    in-out property <string> tr-dark: "Dark";
    in-out property <string> tr-show-equipment-images: "Show Equipment Images";
    in-out property <string> tr-zoom: "Zoom";
    in-out property <string> tr-zoom-in: "Zoom In";
    in-out property <string> tr-zoom-out: "Zoom Out";
    in-out property <string> tr-reset-zoom: "Reset Zoom";
    in-out property <string> tr-refresh: "Refresh";
    in-out property <string> tr-tools: "Tools";
    in-out property <string> tr-settings: "Settings…";
    in-out property <string> tr-interface-language: "Interface Language";
    in-out property <string> tr-english: "English";
    in-out property <string> tr-russian: "Russian";
    in-out property <string> tr-data-paths: "Data Paths…";
    in-out property <string> tr-reset-settings: "Reset Settings";
    in-out property <string> tr-help: "Help";
    in-out property <string> tr-user-guide: "User Guide";
    in-out property <string> tr-about-toeditor: "About TOEditor…";
    in-out property <string> tr-check-for-updates: "Check for Updates";

    // File menu callbacks
    callback file-new-library();
    callback file-open-library();
    callback file-recent-libraries();
    callback file-save-library();
    callback file-save-library-as();
    callback file-import-library();
    callback file-import-formation();
    callback file-export-library();
    callback file-export-formation();
    callback file-export-spreadsheet();
    callback file-export-diagram();
    callback file-exit();

    // Edit menu callbacks
    callback edit-find();
    callback edit-find-replace();
    callback edit-undo();
    callback edit-redo();
    callback edit-cut();
    callback edit-copy();
    callback edit-paste();
    callback edit-delete();
    callback edit-add-formation();
    callback edit-edit-properties();

    // Library menu callbacks
    callback library-positions-editor();
    callback library-equipment-editor();
    callback library-formation-levels();
    callback library-branches();
    callback library-branch-categories();
    callback library-properties();
    callback library-manage-tags();
    callback library-export-library();
    callback library-view-history();
    callback library-create-snapshot();
    callback library-compare-versions();
    callback library-revert-to-version();
    callback library-delete();

    // Library dialog callbacks
    callback show-library-dialog(string, int);
    callback library-dialog-accepted(string, string, string, string, string, int);
    callback library-dialog-cancelled();

    // Unit menu callbacks
    callback unit-add-child();
    callback unit-delete();
    callback unit-move-up();
    callback unit-move-down();
    callback unit-summary-table();
    callback unit-export();
    callback unit-view-history();
    callback unit-create-snapshot();
    callback unit-compare-versions();
    callback unit-revert-to-version();

    // View menu callbacks
    callback view-table();
    callback view-diagram();
    callback view-table-and-diagram();
    callback view-symbols-nato();
    callback view-symbols-russia();
    callback view-load-symbols();
    callback view-color-scheme();
    callback switch-theme(string);
    callback view-show-images();
    callback view-zoom-in();
    callback view-zoom-out();
    callback view-zoom-reset();
    callback view-refresh();

    // Tools menu callbacks
    callback tools-settings();
    callback tools-language();
    callback tools-data-paths();
    callback tools-reset-settings();

    // Help menu callbacks
    callback help-user-guide();
    callback help-about();
    callback help-check-updates();

    // Language switching
    callback switch-language(string);
    callback switch-to-english();
    callback switch-to-russian();

    // Library selection and context menu
    callback library-selected(int);
    callback library-right-clicked(int, int);
    callback toggle-libraries-sidebar();
    callback toggle-formations-sidebar();
    // Formations tree
    callback formation-open(int);
    // Tabs
    callback tab-select(int);
    callback tab-close(int);
    callback tab-set-view-mode(int, string);

    // Toolbar button click
    callback toolbar-clicked(string);

    // Keyboard shortcuts
    forward-focus: main-key-handler;
    main-key-handler := FocusScope {
        key-pressed(event) => {
            if (event.modifiers.control && event.text == "s") {
                root.file-save-library();
                return accept;
            }
            if (event.modifiers.control && event.text == "n") {
                root.file-new-library();
                return accept;
            }
            if (event.modifiers.control && event.text == "o") {
                root.file-open-library();
                return accept;
            }
            reject
        }
    }

    MenuBar {
        Menu {
            title: root.tr-file;
            MenuItem {
                title: root.tr-new-library;
                activated => { root.file-new-library(); }
            }
            MenuItem {
                title: root.tr-open-library-ellipsis;
                activated => { root.file-open-library(); }
            }
            MenuItem {
                title: root.tr-recent-libraries;
                activated => { root.file-recent-libraries(); }
            }
            MenuSeparator {}
            MenuItem {
                title: root.tr-save-library;
                activated => { root.file-save-library(); }
            }
            MenuItem {
                title: root.tr-save-library-as;
                activated => { root.file-save-library-as(); }
            }
            MenuSeparator {}
            Menu {
                title: root.tr-import;
                MenuItem {
                    title: root.tr-import-library-from-file;
                    activated => { root.file-import-library(); }
                }
                MenuItem {
                    title: root.tr-import-formation-from-file;
                    activated => { root.file-import-formation(); }
                }
            }
            Menu {
                title: root.tr-export;
                MenuItem {
                    title: root.tr-export-library-ellipsis;
                    activated => { root.file-export-library(); }
                }
                MenuItem {
                    title: root.tr-export-selected-formation;
                    activated => { root.file-export-formation(); }
                }
                MenuItem {
                    title: root.tr-export-as-spreadsheet;
                    activated => { root.file-export-spreadsheet(); }
                }
                MenuItem {
                    title: root.tr-export-diagram;
                    activated => { root.file-export-diagram(); }
                }
            }
            MenuSeparator {}
            MenuItem {
                title: root.tr-exit;
                activated => { root.file-exit(); }
            }
        }
        Menu {
            title: root.tr-edit;
            MenuItem { title: root.tr-find; activated => { root.edit-find(); } }
            MenuItem { title: root.tr-find-and-replace; activated => { root.edit-find-replace(); } }
            MenuSeparator {}
            MenuItem { title: root.tr-undo; activated => { root.edit-undo(); } }
            MenuItem { title: root.tr-redo; activated => { root.edit-redo(); } }
            MenuSeparator {}
            MenuItem { title: root.tr-cut; activated => { root.edit-cut(); } }
            MenuItem { title: root.tr-copy; activated => { root.edit-copy(); } }
            MenuItem { title: root.tr-paste; activated => { root.edit-paste(); } }
            MenuItem { title: root.tr-delete; activated => { root.edit-delete(); } }
            MenuSeparator {}
            MenuItem { title: root.tr-add-new-formation; activated => { root.edit-add-formation(); } }
            MenuItem { title: root.tr-edit-properties; activated => { root.edit-edit-properties(); } }
        }
        Menu {
            title: root.tr-library;
            MenuItem { title: root.tr-positions-and-ranks-editor; activated => { root.library-positions-editor(); } }
            MenuItem { title: root.tr-equipment-and-vehicles-editor; activated => { root.library-equipment-editor(); } }
            MenuItem { title: root.tr-formation-levels; activated => { root.library-formation-levels(); } }
            MenuItem { title: root.tr-branches; activated => { root.library-branches(); } }
            MenuItem { title: root.tr-branch-categories; activated => { root.library-branch-categories(); } }
            MenuItem { title: root.tr-library-properties; activated => { root.library-properties(); } }
            MenuItem { title: root.tr-manage-tags; activated => { root.library-manage-tags(); } }
            MenuItem { title: root.tr-export-library-ellipsis; activated => { root.library-export-library(); } }
            MenuSeparator {}
            Menu {
                title: root.tr-version-control;
                MenuItem { title: root.tr-view-history; activated => { root.library-view-history(); } }
                MenuItem { title: root.tr-create-snapshot; activated => { root.library-create-snapshot(); } }
                MenuItem { title: root.tr-compare-versions; activated => { root.library-compare-versions(); } }
                MenuItem { title: root.tr-revert-to-version; activated => { root.library-revert-to-version(); } }
            }
        }
        Menu {
            title: root.tr-unit;
            MenuItem { title: root.tr-add-child-formation; activated => { root.unit-add-child(); } }
            MenuItem { title: root.tr-delete-this-formation; activated => { root.unit-delete(); } }
            MenuItem { title: root.tr-move-up; activated => { root.unit-move-up(); } }
            MenuItem { title: root.tr-move-down; activated => { root.unit-move-down(); } }
            MenuItem { title: root.tr-summary-table; activated => { root.unit-summary-table(); } }
            MenuItem { title: root.tr-export-this-formation; activated => { root.unit-export(); } }
            MenuSeparator {}
            Menu {
                title: root.tr-version-control;
                MenuItem { title: root.tr-view-history; activated => { root.unit-view-history(); } }
                MenuItem { title: root.tr-create-snapshot; activated => { root.unit-create-snapshot(); } }
                MenuItem { title: root.tr-compare-versions; activated => { root.unit-compare-versions(); } }
                MenuItem { title: root.tr-revert-to-version; activated => { root.unit-revert-to-version(); } }
            }
        }
        Menu {
            title: root.tr-view;
            Menu {
                title: root.tr-view-mode;
                MenuItem { title: root.tr-table; activated => { root.view-table(); } }
                MenuItem { title: root.tr-diagram; activated => { root.view-diagram(); } }
                MenuItem { title: root.tr-table-and-diagram; activated => { root.view-table-and-diagram(); } }
            }
            MenuSeparator {}
            Menu {
                title: root.tr-tactical-symbols;
                MenuItem { title: root.tr-nato-app6; activated => { root.view-symbols-nato(); } }
                MenuItem { title: root.tr-russia-gost; activated => { root.view-symbols-russia(); } }
                MenuItem { title: root.tr-load-custom-set; activated => { root.view-load-symbols(); } }
            }
            Menu {
                title: root.tr-color-scheme;
                MenuItem { title: root.tr-light; activated => { root.switch-theme("light"); } }
                MenuItem { title: root.tr-dark; activated => { root.switch-theme("dark"); } }
            }
            MenuItem { title: root.tr-show-equipment-images; activated => { root.view-show-images(); } }
            MenuSeparator {}
            Menu {
                title: root.tr-zoom;
                MenuItem { title: root.tr-zoom-in; activated => { root.view-zoom-in(); } }
                MenuItem { title: root.tr-zoom-out; activated => { root.view-zoom-out(); } }
                MenuItem { title: root.tr-reset-zoom; activated => { root.view-zoom-reset(); } }
            }
            MenuItem { title: root.tr-refresh; activated => { root.view-refresh(); } }
        }
        Menu {
            title: root.tr-tools;
            MenuItem { title: root.tr-settings; activated => { root.tools-settings(); } }
            Menu {
                title: root.tr-interface-language;
                MenuItem {
                    title: root.tr-english;
                    activated => {
                        root.switch-language("en");
                        root.switch-to-english();
                    }
                }
                MenuItem {
                    title: root.tr-russian;
                    activated => {
                        root.switch-language("ru");
                        root.switch-to-russian();
                    }
                }
            }
            MenuItem { title: root.tr-data-paths; activated => { root.tools-data-paths(); } }
            MenuItem { title: root.tr-reset-settings; activated => { root.tools-reset-settings(); } }
        }
        Menu {
            title: root.tr-help;
            MenuItem { title: root.tr-user-guide; activated => { root.help-user-guide(); } }
            MenuItem { title: root.tr-about-toeditor; activated => { root.help-about(); } }
            MenuItem { title: root.tr-check-for-updates; activated => { root.help-check-updates(); } }
        }
    }

    VerticalBox {
        // ===== Toolbar =====
        Rectangle {
            height: 40px;
            background: AppTheme.bg-toolbar;
            HorizontalBox {
                padding: 4px;
                spacing: 2px;

                for btn[index] in root.toolbar: Rectangle {
                    if btn.is-separator: Rectangle {
                        width: 1px;
                        height: 24px;
                        background: AppTheme.separator;
                    }
                    if !btn.is-separator: Rectangle {
                        min-width: 32px;
                        max-width: 100px;
                        height: 30px;
                        background: tb-touch.has-hover && btn.enabled ? AppTheme.bg-hover : transparent;
                        border-radius: 4px;
                        HorizontalBox {
                            padding-left: 8px;
                            padding-right: 8px;
                            Text {
                                text: btn.text;
                                font-size: 12px;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                                color: btn.enabled ? AppTheme.text-primary : AppTheme.text-secondary;
                            }
                        }
                        tb-touch := TouchArea {
                            clicked => {
                                if (btn.enabled) {
                                    root.toolbar-clicked(btn.id);
                                }
                            }
                        }
                    }
                }

                Rectangle { horizontal-stretch: 1; }

                // Language quick-switch
                Rectangle { width: 1px; height: 24px; background: AppTheme.separator; }
                Text {
                    text: root.tr-language;
                    font-size: 12px;
                    vertical-alignment: center;
                    color: AppTheme.text-secondary;
                }
                Button {
                    text: "EN";
                    clicked => {
                        root.switch-language("en");
                        root.switch-to-english();
                    }
                }
                Button {
                    text: "RU";
                    clicked => {
                        root.switch-language("ru");
                        root.switch-to-russian();
                    }
                }
            }
        }

        // ===== Main content: sidebars + center with tabs =====
        HorizontalBox {
            // === Left: Collapsible Libraries sidebar ===
            Rectangle {
                width: root.libraries-sidebar-expanded ? 220px : 28px;
                background: AppTheme.bg-sidebar;
                border-width: 1px;
                border-color: AppTheme.border;
                VerticalBox {
                    if root.libraries-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        HorizontalBox {
                            Text {
                                text: root.tr-libraries;
                                font-size: 14px;
                                font-weight: 700;
                                vertical-alignment: center;
                                color: AppTheme.text-primary;
                            }
                            Rectangle { width: 1px; }
                            collapse-libs := Rectangle {
                                width: 20px;
                                height: 20px;
                                background: touch-collapse-libs.has-hover ? AppTheme.bg-hover : transparent;
                                border-radius: 3px;
                                Text {
                                    text: "◀";
                                    font-size: 11px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                    color: AppTheme.text-secondary;
                                }
                                touch-collapse-libs := TouchArea {
                                    clicked => { root.toggle-libraries-sidebar(); }
                                }
                            }
                        }
                        Rectangle { height: 8px; }
                        Rectangle {
                            background: AppTheme.bg-list;
                            border-width: 1px;
                            border-color: AppTheme.border-light;
                            ScrollView {
                                Rectangle {
                                    background: AppTheme.bg-list;
                                    VerticalBox {
                                        for library[index] in root.libraries: Rectangle {
                                            height: 28px;
                                            background: library.id == root.current-library-id
                                                ? AppTheme.bg-selected
                                                : (touch-lib.has-hover ? AppTheme.bg-hover : AppTheme.bg-list);
                                            HorizontalBox {
                                                padding: 4px;
                                                Text {
                                                    text: library.name;
                                                    font-size: 12px;
                                                    overflow: elide;
                                                    color: AppTheme.text-primary;
                                                }
                                            }
                                            touch-lib := TouchArea {
                                                clicked => {
                                                    root.library-selected(library.id);
                                                }
                                                pointer-event(event) => {
                                                    if (event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                                                        root.library-right-clicked(library.id, index);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        Rectangle { }
                    }
                    if !root.libraries-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        expand-libs := Rectangle {
                            width: 24px;
                            height: 24px;
                            background: touch-expand-libs.has-hover ? AppTheme.bg-hover : transparent;
                            border-radius: 3px;
                            Text {
                                text: "▶";
                                font-size: 12px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                color: AppTheme.text-secondary;
                            }
                            touch-expand-libs := TouchArea {
                                clicked => { root.toggle-libraries-sidebar(); }
                            }
                        }
                        Rectangle { }
                    }
                }
            }

            // === Collapsible Formations sidebar (only when library open) ===
            if root.current-library-id >= 0: Rectangle {
                width: root.formations-sidebar-expanded ? 200px : 28px;
                background: AppTheme.bg-sidebar-alt;
                border-width: 1px;
                border-color: AppTheme.border;
                HorizontalBox {
                    if root.formations-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        HorizontalBox {
                            Text {
                                text: root.tr-unit;
                                font-size: 14px;
                                font-weight: 700;
                                vertical-alignment: center;
                                color: AppTheme.text-primary;
                            }
                            Rectangle { width: 1px; }
                            collapse-form := Rectangle {
                                width: 20px;
                                height: 20px;
                                background: touch-collapse-form.has-hover ? AppTheme.bg-hover : transparent;
                                border-radius: 3px;
                                Text {
                                    text: "◀";
                                    font-size: 11px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                    color: AppTheme.text-secondary;
                                }
                                touch-collapse-form := TouchArea {
                                    clicked => { root.toggle-formations-sidebar(); }
                                }
                            }
                        }
                        Rectangle { height: 8px; }
                        Rectangle {
                            background: AppTheme.bg-list;
                            border-width: 1px;
                            border-color: AppTheme.border-light;
                            ScrollView {
                                Rectangle {
                                    background: AppTheme.bg-list;
                                    VerticalBox {
                                        for formation[index] in root.formations: Rectangle {
                                            height: 26px;
                                            background: touch-form.has-hover ? AppTheme.bg-hover : transparent;
                                            HorizontalBox {
                                                padding-left: formation.depth * 12px + 4px;
                                                padding-top: 4px;
                                                padding-bottom: 4px;
                                                Text {
                                                    text: formation.name;
                                                    font-size: 12px;
                                                    overflow: elide;
                                                    color: AppTheme.text-primary;
                                                }
                                            }
                                            touch-form := TouchArea {
                                                clicked => {
                                                    root.formation-open(formation.id);
                                                }
                                            }
                                        }
                                        if root.formations.length == 0: Rectangle {
                                            height: 60px;
                                            Text {
                                                text: root.tr-welcome-desc;
                                                font-size: 11px;
                                                wrap: word-wrap;
                                                color: AppTheme.text-secondary;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        Rectangle { }
                    }
                    if !root.formations-sidebar-expanded: VerticalBox {
                        padding: 8px;
                        expand-form := Rectangle {
                            width: 24px;
                            height: 24px;
                            background: touch-expand-form.has-hover ? AppTheme.bg-hover : transparent;
                            border-radius: 3px;
                            Text {
                                text: "▶";
                                font-size: 12px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                color: AppTheme.text-secondary;
                            }
                            touch-expand-form := TouchArea {
                                clicked => { root.toggle-formations-sidebar(); }
                            }
                        }
                        Rectangle { }
                    }
                }
            }

            // === Center: Tab bar + content ===
            VerticalBox {
                // Tab bar
                Rectangle {
                    height: 32px;
                    background: AppTheme.bg-toolbar;
                    border-width: 1px;
                    border-color: AppTheme.border;
                    HorizontalBox {
                        padding: 4px;
                        spacing: 2px;
                        for tab[index] in root.open-tabs: Rectangle {
                            height: 28px;
                            min-width: 80px;
                            background: index == root.current-tab-index
                                ? AppTheme.bg-tab-active
                                : (touch-tab.has-hover ? AppTheme.bg-hover : AppTheme.bg-tab-inactive);
                            border-width: 1px;
                            border-color: AppTheme.border;
                            HorizontalBox {
                                padding: 6px;
                                touch-tab := TouchArea {
                                    Text {
                                        text: tab.title;
                                        font-size: 12px;
                                        overflow: elide;
                                        vertical-alignment: center;
                                        color: AppTheme.text-primary;
                                    }
                                    clicked => { root.tab-select(index); }
                                }
                                Rectangle { width: 4px; }
                                close-btn := Rectangle {
                                    width: 18px;
                                    height: 18px;
                                    background: touch-close.has-hover ? AppTheme.bg-hover : transparent;
                                    border-radius: 3px;
                                    Text {
                                        text: "×";
                                        font-size: 14px;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                        color: AppTheme.text-secondary;
                                    }
                                    touch-close := TouchArea {
                                        clicked => { root.tab-close(index); }
                                    }
                                }
                            }
                        }
                    }
                }
                // Tab content area
                Rectangle {
                    background: AppTheme.bg-content;
                    border-width: 1px;
                    border-color: AppTheme.border-light;
                    VerticalBox {
                        Rectangle { }
                        if root.open-tabs.length == 0: VerticalBox {
                            padding: 40px;
                            alignment: center;
                            Text {
                                text: root.tr-welcome-title;
                                font-size: 22px;
                                font-weight: 700;
                                color: AppTheme.text-primary;
                            }
                            Rectangle { height: 12px; }
                            Text {
                                text: root.tr-welcome-desc;
                                font-size: 14px;
                                color: AppTheme.text-secondary;
                            }
                        }
                        if root.open-tabs.length > 0 && root.current-tab-index >= 0: VerticalBox {
                            padding: 8px;
                            // View mode selector for current tab
                            HorizontalBox {
                                spacing: 8px;
                                padding-bottom: 8px;
                                Button {
                                    text: root.tr-table;
                                    clicked => { root.tab-set-view-mode(root.current-tab-index, "table"); }
                                }
                                Button {
                                    text: root.tr-diagram;
                                    clicked => { root.tab-set-view-mode(root.current-tab-index, "diagram"); }
                                }
                                Button {
                                    text: root.tr-table-and-diagram;
                                    clicked => { root.tab-set-view-mode(root.current-tab-index, "both"); }
                                }
                            }
                            Rectangle {
                                background: AppTheme.bg-content;
                                VerticalBox {
                                    padding: 16px;
                                    Text {
                                        text: root.current-tab-view-mode == "table"
                                            ? (root.tr-table + " — " + root.current-tab-title)
                                            : (root.current-tab-view-mode == "diagram"
                                                ? (root.tr-diagram + " — " + root.current-tab-title)
                                                : (root.tr-table-and-diagram + " — " + root.current-tab-title));
                                        font-size: 14px;
                                        color: AppTheme.text-primary;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
